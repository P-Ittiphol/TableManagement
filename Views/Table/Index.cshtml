@model TableManagement.ViewModels.TableManageViewModel


@if (TempData["Error"] != null)
{
    <div style="color:red">@TempData["Error"]</div>
}

@{
    ViewData["Title"] = "Table Management";
    ViewData["PageHeader"] = "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£";
    var currentZone = ViewBag.CurrentZone as string;
}

<div class="main-layout pt-5" style="display: flex; gap: 20px; margin-top: 50px;">
    <div class="left-panel">

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô -->
    <div class="mb-4">
        <a asp-action="Index" class="btn btn-secondary">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        <a asp-action="Index" asp-route-zone="A" class="btn btn-primary">‡πÇ‡∏ã‡∏ô A</a>
        <a asp-action="Index" asp-route-zone="B" class="btn btn-success">‡πÇ‡∏ã‡∏ô B</a>
    </div>

    <!-- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    @if (string.IsNullOrEmpty(currentZone))
    {
        <!-- ‡πÇ‡∏ã‡∏ô A -->
        <div class="table-grid">
            @foreach (var table in Model.Tables!.Where(t => t.Zone == "A"))
            {
                <a asp-action="Index"
                    asp-route-zone="@currentZone"
                    asp-route-tableId="@table.Id"
                    class="table-box @(table.Status == "‡∏ß‡πà‡∏≤‡∏á" ? "‡∏ß‡πà‡∏≤‡∏á" : "occupied")">
                    @table.TableCode
                </a>
            }
        </div>

        <hr class="my-4" />

        <!-- ‡πÇ‡∏ã‡∏ô B -->
        <div class="table-grid">
            @foreach (var table in Model.Tables!.Where(t => t.Zone == "B"))
            {
                <a asp-action="Index"
                    asp-route-zone="@currentZone"
                    asp-route-tableId="@table.Id"
                    class="table-box @(table.Status == "‡∏ß‡πà‡∏≤‡∏á" ? "‡∏ß‡πà‡∏≤‡∏á" : "occupied")">
                    @table.TableCode
                </a>
            }
        </div>
    }
    else
    {
        <!-- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
        <div class="table-grid">
            @foreach (var table in Model.Tables!.Where(t => t.Zone == currentZone))
            {
                <a asp-action="Index"
                    asp-route-zone="@currentZone"
                    asp-route-tableId="@table.Id"
                    class="table-box @(table.Status == "‡∏ß‡πà‡∏≤‡∏á" ? "‡∏ß‡πà‡∏≤‡∏á" : "occupied")">
                    @table.TableCode
                </a>
            }
        </div>
    }
    
</div>

    <div class="right-panel">
    <div id="rightContent">
        <h4>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞</h4>

        <div id="actionButtons" style="display: none;">
            <a id="editBtn" class="btn btn-primary" href="#">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            <a id="deleteBtn" class="btn btn-danger" href="#">‡∏•‡∏ö</a>
        </div>
    </div>

    @if (Model.Table != null)
    {
        <div id="tableDetailSection">

            <div class="card p-3 mt-3">
                <h5>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>

                @if (Model.Reservation != null)
                {
                    <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</strong> @Model.Reservation.ReservationCode</p>
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> @Model.Reservation.CustomerName</p>
                    <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> @Model.Reservation.PhoneNumber</p>
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á:</strong> @Model.Reservation.ReservationDate.ToString("dd/MM/yyyy")</p>
                    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> @Model.Reservation.Status</p>
                }
                else
                {
                    <div class="alert alert-info">
                        ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                    </div>
                }
            </div>

            <div class="mt-3">
                <a href="javascript:void(0)"
                onclick="openEdit(@Model.Table.Id)"
                class="btn btn-primary me-2">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </a>

                <a href="javascript:void(0)"
                onclick="openDelete(@Model.Table.Id)"
                class="btn btn-danger">
                    ‡∏•‡∏ö
                </a>
            </div>

        </div>
    }
    

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á -->
    <div>
        <hr />
        <a href="javascript:void(0)" 
        onclick="openCreate()"
        class="btn btn-success w-100">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ï‡πä‡∏∞‡πÉ‡∏´‡∏°‡πà
        </a>
    </div>



    </div>

</div>

<script>

    function hideTableDetail() {
    const section = document.getElementById("tableDetailSection");
        if (section) {
            section.style.display = "none";
        }
    }

    function openEdit(id) {
        hideTableDetail();
        loadPanel('/Table/Edit/' + id);
    }

    function openDelete(id) {
        hideTableDetail();
        loadPanel('/Table/Delete/' + id);
    }

    function openCreate() {
        hideTableDetail();
        loadPanel('/Table/Create');
    }

    window.addEventListener("DOMContentLoaded", function () {
        const section = document.getElementById("tableDetailSection");
        if (section) {
            section.style.display = "block";
        }
    });

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener("click", function (e) {

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞
        if (!e.target.closest(".table-box")) {

            document.getElementById("tableInfo").innerHTML = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞";
        }
    });

    function loadPanel(url) {
    fetch(url)
        .then(response => response.text())
        .then(html => {
            document.getElementById("rightContent").innerHTML = html;

            // ‡∏£‡∏≠ DOM ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡πà‡∏≠‡∏ô
            setTimeout(() => {
                attachFormSubmit();
            }, 0);
        })
        .catch(error => console.error("Load panel error:", error));
}

    function attachFormSubmit() {

    const container = document.getElementById("rightContent");
    if (!container) return;

    const form = container.querySelector("form");
    if (!form) return;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        fetch(form.action, {
            method: "POST",
            body: new FormData(form)
        })
        .then(res => {
            if (!res.ok) throw new Error("Network error");
            return res.json();
        })
        .then(data => {

            if (data.success) {
                location.reload();
            }
            else {
                // üî• ‡πÅ‡∏™‡∏î‡∏á alert ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
                showAlert(data.message);
            }

        })
        .catch(err => console.error("Submit error:", err));
    });
}
    function closePanel() {
    const url = new URL(window.location.href);
    window.location.href = url.pathname + url.search;
}

function showAlert(message) {
    const modal = document.createElement("div");
    modal.innerHTML = `
        <div style="
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;">
            
            <div style="
                background: white;
                padding: 20px 30px;
                border-radius: 10px;
                text-align: center;">
                
                <h5>${message}</h5>
                <button onclick="this.closest('div').parentElement.remove()"
                        class="btn btn-danger mt-3">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
</script>